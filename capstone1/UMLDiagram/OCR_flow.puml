' @startuml
' !theme vibrant
' skinparam backgroundColor #FEFEFE
' skinparam componentStyle rectangle
' skinparam ArrowColor #1976D2

' title DasTern OCR Processing Flow (Core Focus)

' package "Input" #E3F2FD {
'     component "Preprocessed Image" as input #90CAF9 {
'         [Optimized Image]
'         [Enhanced Contrast]
'         [Noise Removed]
'     }
' }

' package "OCR Processing Layer" #FFCCBC {
    
'     component "OCR Router" as router #FFAB91 {
'         [Service Selector]
'         [Load Balancer]
'         [Fallback Handler]
'     }
    
'     note right of router
'         **Router Logic:**
'         1. Select primary OCR service
'         2. Send image for processing
'         3. If failure, retry with alternative
'         4. Return best result
'     end note
    
'     package "Primary OCR Service" #FFE0B2 {
'         cloud "Google Document AI" as docai #FF9800 {
'             rectangle "Processing Steps" {
'                 [1. Text Detection]
'                 [2. Layout Analysis]
'                 [3. Character Recognition]
'                 [4. Confidence Scoring]
'             }
'         }
        
'         note bottom of docai
'             **Strengths:**
'             âœ“ Fast (cloud-based)
'             âœ“ High accuracy
'             âœ“ No training needed
'             âœ“ Handles complex layouts
            
'             **Output:**
'             Raw extracted text
'             + Confidence scores
            
'             âš ï¸ **Privacy Concern:**
'             Sends patient data to
'             external third-party service
'         end note
'     }
    
'     package "Alternative OCR Service" #DCEDC8 {
'         component "Tesseract OCR" as tesseract #8BC34A {
'             rectangle "Processing Steps " {
'                 [1. Image Analysis]
'                 [2. Pattern Recognition]
'                 [3. Language Models]
'                 [4. Text Extraction]
'             }
'         }
        
'         note bottom of tesseract
'             **Strengths:**
'             âœ“ Offline capable
'             âœ“ Customizable
'             âœ“ Khmer language support
'             âœ“ No API costs
            
'             **Output:**
'             Raw extracted text
'             + Line/word positions
            
'             âœ… **Privacy Advantage:**
'             Processes locally on device
'             No data sent to third parties
'             Full data privacy control
'         end note
'     }
    
'     component "Result Aggregator" as aggregator #FF8A65 {
'         [Parse OCR Output]
'         [Normalize Format]
'         [Detect Errors]
'         [Merge Results]
'     }
    
'     note right of aggregator
'         **Aggregation:**
'         â€¢ Compare confidence scores
'         â€¢ Select best result
'         â€¢ Format as plain text
'         â€¢ Flag low-confidence areas
'     end note
' }

' package "Output" #C8E6C9 {
'     component "OCR Result" as output #81C784 {
'         [Raw Extracted Text]
'         [Confidence Scores]
'         [Error Flags]
'     }
    
'     note right of output
'         **Example Output:**
'         "Paracetmol 500m
'         Take 3 time daily
'         After meel"
        
'         (Contains OCR errors
'         to be fixed by AI layer)
'     end note
' }

' ' Main Flow
' input -> router : "Optimized Image"

' router -> docai : "Primary Request"
' docai -> aggregator : "Text + Confidence"

' router -[#FF0000]-> tesseract : "Fallback\n(if primary fails)"
' tesseract -[#FF0000]-> aggregator : "Alternative Text"

' aggregator -> output : "Best OCR Result"

' ' Error handling
' docai -[#FF0000]-> router : "Error/Timeout"
' note on link : Automatic retry

' legend right
'     |= Component |= Purpose |
'     | <back:#FFAB91>OCR Router</back> | Service selection & fallback |
'     | <back:#FF9800>Document AI</back> | Primary OCR engine (cloud) |
'     | <back:#8BC34A>Tesseract</back> | Backup OCR engine (offline) |
'     | <back:#FF8A65>Aggregator</back> | Result processing |
    
'     **Flow:**
'     Normal â†’ <back:#90EE90>Green arrows</back>
'     Error/Fallback â†’ <back:#FFB6C1>Red arrows</back>
    
'     ===
'     **ðŸ”’ DATA PRIVACY CONSIDERATION:**
    
'     **Current Model Options:**
'     1. **Document AI + DeepSeek** (External Services)
'        â€¢ Fast and accurate processing
'        â€¢ âš ï¸ Patient data sent to third parties
'        â€¢ Privacy and security concerns
    
'     2. **Tesseract OCR** (Local Processing)
'        â€¢ âœ… All processing on device
'        â€¢ âœ… No data leakage to external services
'        â€¢ âœ… Full privacy control
'        â€¢ Recommended for sensitive medical data
    
'     **Future Implementation:**
'     Due to security and data privacy concerns,
'     we will consider using **Tesseract OCR**
'     as the primary option to keep patient
'     prescription data secure and private.
' endlegend

' @enduml









@startuml OCR_Flow
!theme vibrant
skinparam backgroundColor #FEFEFE
skinparam componentStyle rectangle
skinparam ArrowColor #1976D2

title DasTern - OCR Processing Flow

actor "Patient/Doctor" as user #64B5F6

node "Mobile Layer" #E3F2FD {
    component "Camera Interface" as camera #90CAF9
}

node "Image Preprocessing" #FFF9C4 {
    node "Preprocessor" as preprocess #FFF176 {
        [Resize/Rotation\nContrast Enhancement\nNoise Reduction] 
        ' [Contrast Enhancement]
        ' [Noise Reduction]
    }
    node "OCR Processing" #FFCCBC {
        component "Google Document AI" as docai #FF9800
        component "Tesseract OCR" as tesseract #8BC34A
    }

node "AI Enhancement" #E1BEE7 {
    cloud "Deepseek/Own Model AI" as deepseek #BA68C8 {
        [Spelling Correction\nMedical Term Recognition\nDosage Parsing]
        ' [Medical Term Recognition]
        ' [Dosage Parsing]
    }
}
}



node "Output" #C8E6C9 {
    component "JSON Formatter" as json #66BB6A
}

user --> camera : Capture Prescription
camera --> preprocess : Send Image
preprocess --> docai : Process
preprocess --> tesseract : Process
docai --> deepseek : Send Raw Text
tesseract --> deepseek : Send Raw Text
deepseek --> json : Cleaned Data
json --> user : Display Results

@enduml